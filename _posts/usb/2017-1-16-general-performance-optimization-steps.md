---
layout: post
title: linux通用性能优化步骤
category: usb
tags: usb,性能
---

# 1、概述
系统性能优化主要是指通过合理分配系统资源，修改软件程序逻辑、结构算法等技术手段提升软件产品的各项性能指标，如吞吐量、响应时间等。

系统优化的一般步骤为测量系统当前性能，设定调试目标，寻找性能瓶颈，调整参数，验证结果。在寻找瓶颈过程中需要大量的测试和记录，从而缩小范围，确认瓶颈。

# 2、系统性能测量
## 2.1 测试准备
测试前准备测试环境、测试设备，并且记录测试人员和测试时间，产品型号，产品硬件信息，产品软件版本，列出需要测试的测试项。确认测试方法，找到一种或多种合适的测试方案。
## 2.2 测试基准
用当前设备和环境测试出一组基础数据，度量当前系统现状，以便于与后期测试数据作为对比。
## 2.3 测试原则
- 测试基准一定要多次测量，保证其准确性
- 测试标准方法统一。最好自动化，手动测试也需要确保每次测试的外部因素没有变化，如测试工具、测试设备、被测试对象等
- 条件允许时，需要多种测试工具或者手段独立测试，通过相互印证排除测试工具的影响。
- 测试最重要的一条是单一变量原则。每次的测试只能改动一项设置，避免多种因素相互影响

# 3、设定调试目标
当测试了目前系统现状后，可根据产品需求或者用户要求设定调试目标，如usb速率达到多少合适等。调试目标是系统调优的目的，是交互标准。

如果有硬性的性能指标，则该指标就是调试目标。但也有需要评估系统后，根据实际状况才能给出指标，这时就需要在前面测试基准上面，通过综合评估系统和产品需求，以及性能理论指标给出调试目标。

# 4、寻找性能瓶颈
性能调优的主要工作就是寻找造成当前系统性能问题的最大瓶颈组件，在其他组件有足够能力维持高性能时，通过修改瓶颈，可以有很大的性能提升。寻找性能瓶颈可以从大范围逐渐减小，直到确认。

系统性能瓶颈主要是某组件或多个组件相互过度消耗资源导致系统性能不足从而导致程序响应速度慢。目前系统资源主要包含四方面：cpu、内存、磁盘、网络。
## 4.1 性能测试工具
linux自带很多性能监控工具，常用工具如下
- top 展示进程的实际活动
- vmstat 显示关于进程，内存，页，块I/O，traps和CPU的信息。
- uptime 查看服务器运行了多长时间，有多少用户登录在服务器上，以及服务器的平均负载
- ps 展示所有进程列表。
- free 显示了系统所有已用和可用内存量
- iostat CPU和磁盘设备利用情况
- mpstat 展示多处理器服务器上每个可用CPU活动信息的命令。
- sar 可以收集、展示和保存系统信息
- netstat 展示网络相关信息
- tcpdump 抓包和分析网络流量
- strace 拦截和记录进程的系统调用或进程接收到的信号
- proc文件系统 提供运行内核监控和操作接口

## 4.2 cpu瓶颈
CPU主要用于 中断、内核进程以及用户进程的任务处理。其优先级从高到底为中断、内核进程、用户进程。cpu性能评估主要有三个指标上下文切换、负载、cpu利用率
### 4.2.1 上下文切换
每个CPU在同一时间只能执行一个进程或线程。Linux采用的是抢占式调度，每个线程分配一定的执行时间，当到达执行时间、线程中有IO阻塞或高优先级线程要执行时，Linux要存储目前线程的执行状，并恢复要执行的线程的状态，这个过程就称为上下文切换（进程调度）
### 4.2.2 负载
每个cpu维护一个线程运行队列，负载用于描述运行队列的状态。系统负载时正在执行的进程与cpu运行队列中进程的结合。 
可以通过uptime查看CPU在最近时间负载状况，load average 值包括进程处于R运行态和不可中断状态D的进程，也就是需要立即使用cpu，也还需要其他进程使用完cpu进程和需要继续处理，但需要等待磁盘输入输出完成才能进行的进程。
### 4.2.3 cpu利用率
CPU 利用率被定义为 CPU 使用的百分比，用户进程、内核进程、中断处理、IO等待以及空闲五个部分使用的百分比，这五个值是用来分析CPU消耗情况的关键指标。

### 4.2.4 smp 系统
在多核系统中，有一个cpu affinity的概念，可以绑定进程到一个cpu。这样主要是做cpu缓存优化，让同一个进程只在一个cpu上运行，而不用在多个cpu切换。当进程在多个cpu切换时会导致很多缓存刷新，导致一个独立进程需要很久才处理网。多核系统中，独立进程绑定cpu保持内存缓存cpu访问都是本地的，很有用。

### 4.2.5 cpu瓶颈判断
top命令查看cpu利用率和占用cpu高的进程。
```
Mem: 77168K used, 178800K free, 0K shrd, 7280K buff, 23536K cached
CPU:  0.0% usr  4.5% sys  0.0% nic 95.4% idle  0.0% io  0.0% irq  0.0% sirq
Load average: 0.00 0.01 0.05 1/56 825
  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
  825   577 root     R     1236  0.4   0  4.5 top
```
当CPU消耗严重时，主要体现在usr、sys、 io 、 irq 、 sirq值变高，io的值是IO等待造成的，irq的值变高主要为硬件中断造成的，例如网卡接受数据频繁的状况，sirq变高是软件中断，主要是下半部处理太频繁，如收发数据包或者上传协议栈数据包太多等，usr太高则是应用程序占用cpu太多，需要优化程序或算法。sys太高则有可能是系统调用太多导致。
## 4.3 内存瓶颈
应该程序访问内存数据的效率要比磁盘高，为了提高效率，linux对程序需要的数据都做了缓存。linux中同一时间可以多个用户运行多个程序，不同的程序内存大小不一，linux通过一定算法策略决定哪些程序使用物理内存，哪些从内存中移除，达到满足所有程序的内存需要，也就是内存管理。如果有交换分区，就会通过页面调度和交换，将部分内存数据换出到交换分区，这样可以将空闲的内存用作需要的程序。
当内存不足时，系统就会频繁的将内存换出到交换分区。

当没有交换分区时，可以通过系统剩余内存来判断是否内存不足。

内存查看可用过top、free、vmstat、proc文件等工具。
/proc/meminfo 机器的内存使用信息
/proc/pid/maps 显示当前进程所占用的虚拟地址
```
free
             total       used       free     shared    buffers     cached
Mem:        255968      77884     178084          0       7280      24080
-/+ buffers/cache:      46524     209444
Swap:            0          0          0
```
free查看内存，实际可用内存=free+buffer+cache，下面情况说明内存不足
- 可用内存（free+buffers/cache）过低，接近于0的时候
- 交换分区内存占用swap used增加或者有波动
- 内核产生oom，oom-killer显示有OutOfMemory-killer正在运行

## 4.4 磁盘瓶颈
磁盘io是linux系统中最慢的部分。linux磁盘读取和写入不是直接操作磁盘，而是虚拟内存来映射实际的物理地址空间。内核搜索数据首先搜索cpu缓存，然后是物理内存，都不存在时，才会到磁盘中获取并缓存。磁盘慢时，主要表现为内存缓存中填满了写数据，因没有内存用于缓存写而拖慢了写入请求或者等待磁盘队列中读数据响应。

磁盘监控可以使用vmstat和iostat工具测试。vmstat中bi/bo来判断磁盘读取和写入，如果过大，且wa占比较高则io有瓶颈。
## 4.5 网络瓶颈
网络瓶颈主要为网络设备、配置、防火墙、网络拓扑等导致网络传输性能和稳定性问题，导致服务不正常。主要表现为网络传输延时大，丢包等。可以通过抓包工具以及性能分析工具来确定。

# 5、性能调优
通过上面性能瓶颈的查找，我们需要修改瓶颈，然后让系统达到最优。可能会有两种，一种是当前任务资源消耗较多，导致性能问题；一种是其他任务消耗资源多，导致本任务需要的资源不够，导致性能问题。前者需要优化当前任务路径，后者需要控制资源，或者去除一部分不需要的任务。在性能优化过程中，需要尝试一个选项后，测试并记录原始数据和条件，也许会多个选项相互影响，这也需要数据支撑，所以优化就是一个反复测试验证的过程。下面列举一些通用的优化方法
## 5.1 cpu性能优化
1. ps查找后台不必要程序，关掉它，或者通过定时运行它，让其在非高峰时运行。
2. 降低cpu密集型且不重要的进程优先级
3. 基于smp机器上，通过taskset将进程绑定到特定cpu，避免多个cpu切换
4. 合并中断，减少中断处理过程

## 5.2 内存性能优化
1. 每个进程内存限额，减少内存使用
2. 关闭掉非必须任务
3. 增加内存

## 5.3 磁盘性能优化
1. 添加更快的磁盘控制器
2. 更换好的磁盘，添加磁盘数量
3. 增加ram，系统内存增加可以提高系统磁盘缓冲
5. 调整/proc下内核脏页回写以及内存其他参数
6. io调度算法调整和选择
7. 文件系统匹配，挂载模式选择
8. 块大小调整

## 5.4 网络性能优化
1. 修改组网方式，更换网络设备
2. 调节内核tcp/ip参数
3. 调整mtu大小
4. 增加网络缓冲
5. 增加包队列，发送接收队列
6. 减少数据拷贝，优化数据传输路径

# 6、usb性能优化
## 6.1 测量当前系统usb性能标准
### 6.1.1 确认测试环境及测试方法测试项目
1. 测试环境：因usb性能测试与pc端有关联，所以需要选定固定电脑，并且关闭电脑上其他软件。usb磁盘设备选取性能最好的，排除因设备端导致的性能瓶颈。
2. 测试方法：测试通过smb和ftp两种用户应用来测试对应usb文件共享数据传输性能。   
1). 通过windows进入usb共享目录，通过记录windows拷贝一定大小文件（2g或者其他）的时间，来统计速度。结果需要多次测量取平均值。   2).    通过测试工具Benchmark、ftp客户端等拷贝文件，读取传输速率。   3).  因文件系统不一致，每种文件系统都需要一组测试基准。每组数据包括磁盘读取和写入
3. 确认测试软件及硬件信息。统计当前系统状态，cpu、内存、磁盘io等，确认当前软件模块，记录所有信息

## 6.2 设定调试目标
性能指标一种是需求文档规定性能指标，一种是目标竞品信息。如果是目标竞品，则在当前测试环境下，用相同的测试方法测试目标竞品的性能和产品系统信息，以此作为调试目标。
## 6.3 寻找性能瓶颈，调试验证
### 6.3.1 查看系统状态
通过top工具查看
```

Mem: 198144K used, 57824K free, 0K shrd, 7752K buff, 138340K cached
CPU:  4.4% usr 25.3% sys  0.0% nic  8.1% idle  0.7% io  0.0% irq 61.2% sirq
Load average: 1.62 1.43 1.39 2/63 13949
  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
13429 13394 admin    D     3428  1.3   1 47.2 /usr/sbin/smbd -D
13232     2 root     RW       0  0.0   0 16.6 [usb-storage]
 1400     1 root     S     6836  2.6   0  1.6 /usr/bin/ucloud -l 3
  138     2 root     SW       0  0.0   0  1.3 [kswapd0]
    9     2 root     SW       0  0.0   1  1.0 [ksoftirqd/1]
    3     2 root     SW       0  0.0   0  0.6 [ksoftirqd/0]
  286     2 root     SW       0  0.0   1  0.4 [mtdblock3]
```
通过查看发现，Load average 平均负载超过1，系统较繁忙，可以使用， sirq软中断占用61.2%。free较多内存，io占用比例不大，还有smb进程cpu占用很高，所以主要瓶颈在于cpu。
通过vmstat查看系统状态

```
vmstat 2
procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa
 0  0      0  55592   7756 140592    0    0     0     0   54   29  0  2 98  0
 1  0      0  57848   7780 138316    0    0     0     0 6114 1861  3 81 15  1
 1  0      0  52820   7756 142536    0    0     0     0 6902 1957  4 86  7  3
 2  0      0  53184   7756 142972    0    0     0     0 6855 2045  7 85  7  1
 1  0      0  54040   7712 142144    0    0     0     0 6889 2038  6 83 12  0
```
我们首先思考cpu占用过高。
### 6.3.2 分析优化
分析usb数据传输路径，然后减少系统处理以及数据包处理，从而降低cpu处理时间。
1. 数据流程：
电脑---->smb应用----->系统调用陷入内核---->vfs----->fat/ntfs--->scsi--->usb       
分别测量数据由应用层到内存和内存到磁盘的速率。
2. 通过合并数据流（gro）来减少中断处理
3. Smb的性能通过调节smb配置实现性能提升
4. 文件系统通过改变mount参数调节
5. 查看中断/proc/interrupts ,将usb中断与其他网络中断分在不同cpu上，提高性能
6. 将smb等进程绑定到特定cpu，减少cpu切换
7. 调节proc/sys/vm/下参数如磁盘回写等，用于提升内存性能
8. 通过调节/sys/block/sda下相关磁盘缓冲区、调度算法等提升磁盘性能

调节过程需要反复验证测试结果并记录，直到性能达标。

## 6.4 软件性能对比测试
系统是一个整体结构，调优某一部分模块的性能，不仅可以分析模块本身，也可以通过查看其它模块对其影响，减少其它模块的资源占用，从而间接提高性能。
### 6.4.1 减少其它模块影响
只加载目标模块，其它模块默认不启动，然后测试性能，再一步步添加，找到对目标模块影响最大的模块，优化它，或降低其优先级，或修改代码逻辑，限制资源使用（内存等）。
### 6.4.2 版本迭代对比
有时因版本迭代，添加或者删除功能等导致性能下降，可以直接对比不同版本改动，然后找到性能下降原因并评估修改
### 6.4.3 其他产品对比
产品本身优化没有思路，可以通过网络或者其他类似产品，寻求解决方案。





